import{a1 as f,o as u,a as i,w as m,e as V,b as n,a4 as p,t as h,a5 as y,f as k,Z as v,c as $,a0 as S,a2 as b,a3 as M,Q as R,as as C,a6 as T,ar as Q,W as O,h as j}from"./index-D4Q0ew6z.js";import{Q as _}from"./QBadge-DPX44ib_.js";import{Q as w,a as D}from"./QTh-BaKfnjMH.js";import{Q as q}from"./QMarkupTable-BbBgKwsy.js";import{Q as H}from"./QSpace-Duqy0kKz.js";import{Q as B}from"./QForm-CIlPEVtn.js";import{C as F}from"./ClosePopup-CtxYioMv.js";import{h as g}from"./moment-C5S46NFB.js";import{_ as N}from"./_plugin-vue_export-helper-DlAUqK2U.js";const P={name:"FormularioReservas",props:{agencia:{type:String,required:!1},color:{type:String,required:!1}},data(){return{fecha:g().format("YYYY-MM-DD"),salas:[],horarios:[],seleccionadas:{},totalMinutos:0,dialogoReservar:!1,nombre:"",personas:1,adelanto:0,observacion:"",loading:!1,directo:!1}},computed:{fechaText(){const t=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"],e=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];return`${t[g(this.fecha).day()]} ${g(this.fecha).date()} de ${e[g(this.fecha).month()]} de ${g(this.fecha).year()}`},tiempoSeleccionado(){const t=Math.floor(this.totalMinutos/60),e=this.totalMinutos%60;return`${String(t).padStart(2,"0")}:${String(e).padStart(2,"0")}`},montoTotal(){return this.totalMinutos/30*5*(this.personas||1)},horaMinima(){return Object.keys(this.seleccionadas).length===0?"-":Object.values(this.seleccionadas).map(e=>g(e,"H:mm")).sort((e,r)=>e.diff(r))[0].format("H:mm")},horaMaxima(){if(Object.keys(this.seleccionadas).length===0)return"-";const t=Object.values(this.seleccionadas).map(r=>g(r,"H:mm")).sort((r,a)=>r.diff(a));return t[t.length-1].add(30,"minutes").format("H:mm")}},methods:{esPrimeraCeldaReserva(t,e){const r=`${t}-${e}`,a=`${t-1}-${e}`;return this.$store.reservas[r]?!this.$store.reservas[a]||this.$store.reservas[a].nombre!==this.$store.reservas[r].nombre:!1},getRowspan(t,e){const r=`${t}-${e}`;if(!this.$store.reservas[r])return 1;let a=1;for(;this.$store.reservas[`${t+a}-${e}`]&&this.$store.reservas[`${t+a}-${e}`].nombre===this.$store.reservas[r].nombre;)a++;return a},getReservas(t,e){this.loading=!0,this.$store.reservas={},this.$axios.get("/reservas",{params:{fecha:t,agencia:e}}).then(r=>{this.$store.reservas=r.data}).catch(()=>{this.$alert.error("Error al obtener reservas")}).finally(()=>{this.loading=!1})},limpiar(){this.seleccionadas={},this.totalMinutos=0,this.nombre="",this.personas=1,this.adelanto=0,this.observacion=""},clickReserva(){if(this.totalMinutos===0){this.$alert.error("Por favor selecciona al menos 30 minutos.");return}this.dialogoReservar=!0,this.nombre="",this.personas=2,this.adelanto=0,this.observacion="",this.directo=!1},shouldShowCell(t,e){const r=`${t}-${e}`,a=`${t-1}-${e}`;return this.$store.reservas[r]?!(t>0&&this.$store.reservas[a]&&this.$store.reservas[a].nombre===this.$store.reservas[r].nombre):!0},toggleSeleccion(t,e,r){const a=`${t}-${e}`;if(!this.$store.reservas[a]){if(Object.keys(this.seleccionadas).length===0){this.seleccionadas[a]=r,this.calcularTotalMinutos();return}if(Object.keys(this.seleccionadas).length>0){const s=new Set(Object.keys(this.seleccionadas).map(o=>o.split("-")[1]));if(s.size>0&&!s.has(String(e))){this.$alert.error("Debes seleccionar en la misma sala.");return}const l=Object.keys(this.seleccionadas).map(o=>parseInt(o.split("-")[0])).sort((o,c)=>o-c);if(l.length>0){const o=l[l.length-1];if(t!==o+1){this.$alert.error("Debes seleccionar horarios consecutivos.");return}}}this.seleccionadas[a]?delete this.seleccionadas[a]:this.seleccionadas[a]=r,this.calcularTotalMinutos()}},calcularTotalMinutos(){this.totalMinutos=Object.keys(this.seleccionadas).length*30},confirmarReserva(){Object.keys(this.seleccionadas).forEach(a=>{this.$store.reservas[a]={nombre:this.nombre,personas:this.personas,color:"yellow"}});const e=Object.keys(this.seleccionadas)[0].split("-")[1],r=this.salas[e]?.sala||"Desconocida";this.loading=!0,this.$axios.post("/reservas",{nombre:this.nombre,numero_personas:this.personas,observaciones:this.observacion,json:JSON.stringify(this.seleccionadas),sala:r,total:this.montoTotal,adelanto:this.adelanto,tiempo:this.tiempoSeleccionado,horario:`${this.horaMinima} - ${this.horaMaxima}`,fecha:this.fecha,directo:this.directo,agencia:this.agencia}).then(()=>{this.$alert.success("Reserva confirmada","Reserva"),this.limpiar(),this.getReservas(this.fecha,this.agencia),this.dialogoReservar=!1,this.$socket.emit(`reservas-${this.agencia}`)}).catch(a=>{this.$alert.error(a.response.data.message,"Error al confirmar reserva")}).finally(()=>{this.loading=!1})}},mounted(){console.log("agencia "+this.agencia),console.log("color "+this.color);let t=20;this.agencia==="Ayacucho"&&(t=21);for(let r=0;r<t;r++)this.salas.push({sala:"Sala "+(r+1)});for(let r=8;r<23;r++){let a=`${r}:00`,s=`${r}:30`;this.horarios.push({hora:`${a}-${s}`}),a=`${r}:30`,s=`${r+1}:00`,this.horarios.push({hora:`${a}-${s}`})}this.calcularTotalMinutos(),this.getReservas(this.fecha,this.agencia);let e=this;this.$store.socketReservas||(this.$store.socketReservas={}),this.$store.socketReservas[this.agencia]||(this.$socket.on(`reservas-${this.agencia}`,()=>{e.getReservas(this.fecha,this.agencia)}),this.$store.socketReservas[this.agencia]=!0)}},U={class:"row"},A={class:"col-12"},z={class:"col-6 col-md-2"},E={class:"col-6 col-md-2 text-center flex flex-center"},J={class:"text-bold text-red"},K={class:"col-6 col-md-2 flex flex-center"},Y={class:"col-6 col-md-2"},L={class:"col-6 col-md-2 text-right"},x={class:"scroll-body"},W=["onClick"],Z={key:0},G={key:0},X={class:"text-subtitle2 text-bold"},I={class:"text-red"},ee={class:"text-bold q-mt-md text-blue bg-grey-3"},se={class:"text-bold"},te={class:"text-red text-bold"};function oe(t,e,r,a,s,l){return u(),f(b,null,[i(R,{flat:"",bordered:""},{default:m(()=>[i(V,{class:"q-pa-xs"},{default:m(()=>[n("div",U,[n("div",A,[n("div",{class:p(`bg-${r.color} text-center text-white q-pa-xs`)},h(r.agencia),3)]),n("div",z,[i(y,{modelValue:s.fecha,"onUpdate:modelValue":[e[0]||(e[0]=o=>s.fecha=o),e[1]||(e[1]=o=>l.getReservas(s.fecha,r.agencia))],type:"date",label:"Fecha",dense:"",outlined:""},null,8,["modelValue"])]),n("div",E,[n("div",J,h(l.fechaText),1)]),n("div",K,[i(k,{color:"green",label:"Reservar",onClick:l.clickReserva,"no-caps":"",icon:"save",size:"11px",loading:s.loading},null,8,["onClick","loading"])]),n("div",Y,[i(_,{color:"indigo",class:"q-pa-sm"},{default:m(()=>[v(" Tiempo Seleccionado: "+h(l.tiempoSeleccionado),1)]),_:1})]),n("div",L,[Object.keys(s.seleccionadas).length>0?(u(),$(k,{key:0,color:"red",label:"Limpiar",onClick:l.limpiar,"no-caps":"",icon:"clear",size:"11px"},null,8,["onClick"])):S("",!0)]),e[12]||(e[12]=n("div",{class:"col-6 col-md-2 text-right"},null,-1))]),i(q,{"wrap-cells":"",dense:"",bordered:"",flat:"",separator:"cell",class:"tabla-reservas"},{default:m(()=>[n("thead",null,[n("tr",null,[i(w,{class:"bg-grey text-white sticky-hora"},{default:m(()=>e[13]||(e[13]=[v("Hora")])),_:1}),(u(!0),f(b,null,M(s.salas,o=>(u(),$(w,{class:p(`bg-${r.color} text-white`),key:o.sala},{default:m(()=>[v(h(o.sala),1)]),_:2},1032,["class"]))),128))])]),n("tbody",x,[(u(!0),f(b,null,M(s.horarios,(o,c)=>(u(),f("tr",{key:c},[i(D,{class:"sticky-hora",style:{padding:"0",margin:"0",border:"0"}},{default:m(()=>[v(h(o.hora),1)]),_:2},1024),(u(!0),f(b,null,M(s.salas,(re,d)=>(u(),f("td",{key:d,class:p([{"bg-green text-white":s.seleccionadas[`${c}-${d}`]&&!t.$store.reservas[`${c}-${d}`],"bg-red text-white":t.$store.reservas[`${c}-${d}`]?.color==="red","bg-yellow text-black":t.$store.reservas[`${c}-${d}`]?.color==="yellow","bg-grey-3":!s.seleccionadas[`${c}-${d}`]&&!t.$store.reservas[`${c}-${d}`]},"text-center cursor-pointer"]),onClick:ae=>l.toggleSeleccion(c,d,o.hora)},[t.$store.reservas[`${c}-${d}`]?(u(),f("div",Z,[l.esPrimeraCeldaReserva(c,d)?(u(),f(b,{key:0},[v(h(t.$store.reservas[`${c}-${d}`].nombre)+" ",1),t.$store.reservas[`${c}-${d}`]&&t.$store.reservas[`${c}-${d}`].fecha_confirmacion?(u(),f("div",G,h(t.$store.reservas[`${c}-${d}`].fecha_confirmacion.substring(11,16)),1)):S("",!0)],64)):(u(),f(b,{key:1},[v(" ... ")],64))])):S("",!0)],10,W))),128))]))),128))])]),_:1})]),_:1})]),_:1}),i(j,{modelValue:s.dialogoReservar,"onUpdate:modelValue":e[11]||(e[11]=o=>s.dialogoReservar=o)},{default:m(()=>[i(R,{style:{"min-width":"250px"}},{default:m(()=>[i(V,{class:"q-pb-none row items-center"},{default:m(()=>[n("div",X,[v(h(l.fechaText)+" ",1),n("div",I,h(Object.keys(s.seleccionadas).length>0?s.salas[Object.keys(s.seleccionadas)[0].split("-")[1]].sala:"-"),1)]),i(H),i(k,{flat:"",dense:"",round:"",icon:"close",class:"q-ml-auto",onClick:e[2]||(e[2]=o=>s.dialogoReservar=!1)})]),_:1}),i(V,null,{default:m(()=>[i(B,{onSubmit:C(l.confirmarReserva,["prevent"])},{default:m(()=>[i(y,{modelValue:s.nombre,"onUpdate:modelValue":e[3]||(e[3]=o=>s.nombre=o),label:"Nombre",dense:"",outlined:"",class:"",rules:[o=>!!o||"Por favor, ingresa un nombre."]},null,8,["modelValue","rules"]),i(y,{modelValue:s.personas,"onUpdate:modelValue":e[4]||(e[4]=o=>s.personas=o),modelModifiers:{number:!0},type:"number",label:"Número de Personas",dense:"",outlined:"",class:"",rules:[o=>o>0||"Por favor, ingresa un número válido."]},null,8,["modelValue","rules"]),i(y,{modelValue:s.adelanto,"onUpdate:modelValue":e[5]||(e[5]=o=>s.adelanto=o),modelModifiers:{number:!0},type:"number",label:"Adelanto",dense:"",outlined:"",class:"",rules:[o=>o>=0||"Por favor, ingresa un número válido."]},null,8,["modelValue","rules"]),i(y,{modelValue:s.observacion,"onUpdate:modelValue":e[6]||(e[6]=o=>s.observacion=o),label:"Observación",dense:"",outlined:"",type:"textarea"},null,8,["modelValue"]),t.$store.user.role==="Admin"?(u(),$(T,{key:0,modelValue:s.directo,"onUpdate:modelValue":[e[7]||(e[7]=o=>s.directo=o),e[8]||(e[8]=o=>s.adelanto=l.montoTotal)],label:s.directo?"Venta Directa":"Reserva",class:p({"text-primary":s.directo,"text-orange":!s.directo})},null,8,["modelValue","label","class"])):t.$store.user.sucursal===r.agencia?(u(),$(T,{key:1,modelValue:s.directo,"onUpdate:modelValue":[e[9]||(e[9]=o=>s.directo=o),e[10]||(e[10]=o=>s.adelanto=l.montoTotal)],label:s.directo?"Venta Directa":"Reserva",class:p({"text-primary":s.directo,"text-orange":!s.directo})},null,8,["modelValue","label","class"])):S("",!0),n("div",null,[i(_,{color:"indigo",class:"q-pa-sm"},{default:m(()=>[v(" Horario Seleccionado: Desde "+h(l.horaMinima)+" hasta "+h(l.horaMaxima),1)]),_:1})]),n("div",ee," Tiempo Total: "+h(l.tiempoSeleccionado),1),n("div",se," Monto Total: "+h(l.montoTotal)+" Bs ",1),n("div",te," Saldo: "+h(l.montoTotal-s.adelanto)+" Bs ",1),i(Q,{align:"right"},{default:m(()=>[O(i(k,{flat:"",label:"Cancelar","no-caps":"",loading:s.loading},null,8,["loading"]),[[F]]),i(k,{color:"green",label:"Confirmar","no-caps":"",type:"submit",loading:s.loading},null,8,["loading"])]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}const ve=N(P,[["render",oe]]);export{ve as F};
