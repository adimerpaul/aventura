import{Y as F,c as _,o as m,w as l,b as a,a1 as v,a as s,Q as p,e as d,a5 as x,a6 as j,f as w,a2 as A,a3 as C,t as h,$ as R,a7 as g,Z as f}from"./index-BU3plpon.js";import{Q as b}from"./QBadge-DJokwidu.js";import{Q as y}from"./QChip-BnQaoy-Y.js";import{Q as k}from"./QMarkupTable-B1jPLfSb.js";import{Q as I}from"./QPage-C7Cuzh7s.js";import{m as N,a as P}from"./vue3-apexcharts-CQ4Agfsu.js";import{_ as V}from"./_plugin-vue_export-helper-DlAUqK2U.js";const T={name:"DashboardCine",components:{apexchart:N},data(){return{loading:!1,filters:{fechaInicio:"",fechaFin:"",incluirAnuladas:!1},metricas:null,cajasPeriodo:[],reservasAll:[],ventasAll:[],productosAgg:[],resumen:{ventas:0,reservas:0},ultimasReservas:[],chartCaja:{options:{chart:{toolbar:{show:!1},zoom:{enabled:!1}},stroke:{width:3,curve:"smooth"},dataLabels:{enabled:!1},xaxis:{categories:[]},yaxis:{labels:{formatter:t=>this.formatNumber(t)}},tooltip:{y:{formatter:t=>"Bs "+this.money(t)}}}},chartIngresos:{options:{labels:["Ventas","Reservas"],legend:{position:"bottom"},tooltip:{y:{formatter:t=>"Bs "+this.money(t)}}}},chartReservas:{options:{labels:["Reservado","Finalizado","Cancelado"],legend:{position:"bottom"}}},chartTopProd:{options:{chart:{toolbar:{show:!1}},plotOptions:{bar:{horizontal:!0,borderRadius:6,barHeight:"65%"}},dataLabels:{enabled:!1},xaxis:{categories:[]}}}}},computed:{kpis(){const t=this.cajasPeriodo.reduce((o,i)=>o+Number(i.monto_total||0),0);this.reservasAll.filter(o=>o.estado==="Reservado").length;const e=this.calcTicketPromedio();return[{key:"caja",label:"Total caja (periodo)",value:t,icon:"point_of_sale",color:"teal",formatter:o=>"Bs "+this.money(o),help:"Suma de montos reales de caja"},{key:"ventas",label:"Ventas del periodo",value:this.resumen.ventas,icon:"receipt_long",color:"indigo",formatter:o=>"Bs "+this.money(o),help:"Suma de ventas válidas"},{key:"reservas",label:"Reservas del periodo",value:this.resumen.reservas,icon:"event_available",color:"orange",formatter:o=>"Bs "+this.money(o),help:"Adelantos + saldos"},{key:"avg",label:"Ticket promedio",value:e,icon:"show_chart",color:"purple",formatter:o=>"Bs "+this.money(o),help:"Ventas / nº de ventas aprox."}]},seriesCaja(){const t=this.cajasPeriodo.map(o=>o.fechaFormat||o.fecha),e=this.cajasPeriodo.map(o=>Number(o.monto_total||0));return this.chartCaja.options.xaxis.categories=t,[{name:"Caja (Bs)",data:e}]},seriesIngresos(){return[Number(this.resumen.ventas||0),Number(this.resumen.reservas||0)]},seriesReservas(){const t=this.reservasAll;return[t.filter(e=>e.estado==="Reservado").length,t.filter(e=>e.estado==="Finalizado").length,t.filter(e=>e.estado==="Cancelado").length]},seriesTopProd(){const t=this.topProductos(this.productosAgg);return this.chartTopProd.options.xaxis.categories=t.map(e=>e.nombre),[{name:"Cantidad",data:t.map(e=>e.cantidad)}]}},created(){this.initDates(),this.loadAll()},methods:{initDates(){const t=new Date,e=String(t.getDate()).padStart(2,"0"),o=String(t.getMonth()+1).padStart(2,"0"),i=t.getFullYear();this.filters.fechaInicio=`${i}-${o}-${e}`,this.filters.fechaFin=`${i}-${o}-${e}`},estadoColor(t){return t==="Reservado"?"yellow":t==="Finalizado"?"red":"grey"},formatDate(t){try{return new Date(t).toLocaleString()}catch{return t||"—"}},formatNumber(t){return new Intl.NumberFormat("es-BO").format(Number(t||0))},money(t){return this.formatNumber(Number(t||0).toFixed(2))},apiClient(){const t=P.create({baseURL:"/api"}),e=localStorage.getItem("token");return e&&(t.defaults.headers.common.Authorization=`Bearer ${e}`),t},async loadAll(){this.loading=!0;try{await Promise.all([this.fetchMetricas(),this.fetchReservasAll(),this.fetchVentas()]),this.recalcularResumen(),this.prepareTables()}catch(t){this.$q.notify({type:"negative",message:"Error cargando datos",caption:t?.message||""})}finally{this.loading=!1}},async fetchMetricas(){const{fechaInicio:t,fechaFin:e}=this.filters,{data:o}=await this.$axios.get("/metricas",{params:{fechaInicio:t,fechaFin:e}});this.metricas=o,this.cajasPeriodo=Array.isArray(o?.arrayFecha)?o.arrayFecha:[]},async fetchReservasAll(){const{fechaInicio:t,fechaFin:e}=this.filters,o={fechaInicio:t,fechaFin:e,user_id:0,tipo:"Todo"},{data:i}=await this.$axios.get("/reservasAll",{params:o});this.reservasAll=Array.isArray(i)?i:[]},async fetchVentas(){const{fechaInicio:t,fechaFin:e}=this.filters,{data:o}=await this.$axios.get("/ventas",{params:{fechaInicio:t,fechaFin:e,user_id:""}});this.ventasAll=Array.isArray(o)?o:[];const i={};this.ventasFiltradas().forEach(n=>{Array.isArray(n.detalles)&&n.detalles.forEach(c=>{const u=c.producto_id||c.id||c.producto,r=c.producto||"Producto "+u;i[u]||(i[u]={id:u,nombre:r,cantidad:0}),i[u].cantidad+=Number(c.cantidad||0)})}),this.productosAgg=Object.values(i)},inRange(t){if(!this.filters.fechaInicio&&!this.filters.fechaFin)return!0;const e=new Date(t),o=this.filters.fechaInicio?new Date(this.filters.fechaInicio+"T00:00:00"):null,i=this.filters.fechaFin?new Date(this.filters.fechaFin+"T23:59:59"):null;return!(o&&e<o||i&&e>i)},ventasFiltradas({ignoreAnuladas:t}={}){return this.ventasAll.filter(e=>!(!this.inRange(e.fecha)||!this.filters.incluirAnuladas&&!t&&(e.anulada===1||e.anulada===!0||e.anulada==="1")))},recalcularResumen(){const t=this.ventasFiltradas().reduce((i,n)=>i+Number(n.total||0),0),o=this.reservasAll.filter(i=>["Reservado","Finalizado"].includes(i.estado)).reduce((i,n)=>i+Number(n.adelanto||0)+Number(n.saldo||0),0);this.resumen={ventas:t,reservas:o}},calcTicketPromedio(){const t=Number(this.resumen.ventas||0),e=this.ventasFiltradas().length||1;return t/e},topProductos(t){const e=Array.isArray(t)?t.slice():[];return e.sort((o,i)=>Number(i.cantidad||0)-Number(o.cantidad||0)),e.slice(0,10)},prepareTables(){this.ultimasReservas=[...this.reservasAll].sort((t,e)=>new Date(e.fecha)-new Date(t.fecha)).slice(0,10)}}},Q={class:"row q-col-gutter-md items-stretch"},B={class:"col-12"},D={class:"col-6 col-md-3"},S={class:"col-6 col-md-3"},z={class:"col-12 col-md-2 flex items-center q-gutter-sm"},q={class:"row items-center justify-between"},E={class:"text-caption text-grey-7"},L={class:"text-h5 q-mt-xs"},M={class:"col-12 col-lg-7"},O={key:1,class:"text-grey-6 text-center q-pa-lg"},U={class:"col-12 col-lg-5"},Y={class:"col-12 col-lg-4"},H={class:"col-12 col-lg-8"},Z={class:"col-12"},G={class:"text-right"};function J(t,e,o,i,n,c){const u=F("apexchart");return m(),_(I,{class:"q-pa-md bg-grey-2"},{default:l(()=>[a("div",Q,[a("div",B,[s(p,{class:"shadow-2 rounded-2xl"},{default:l(()=>[s(d,{class:"row q-col-gutter-md items-center"},{default:l(()=>[e[4]||(e[4]=a("div",{class:"col-12 col-md-4"},[a("div",{class:"text-h6"},"Dashboard Cine"),a("div",{class:"text-caption text-grey-7"},"Caja, Ventas, Reservas (según tu sucursal)")],-1)),a("div",D,[s(x,{modelValue:n.filters.fechaInicio,"onUpdate:modelValue":e[0]||(e[0]=r=>n.filters.fechaInicio=r),label:"Fecha inicio",type:"date",dense:"",outlined:"",disable:n.loading},null,8,["modelValue","disable"])]),a("div",S,[s(x,{modelValue:n.filters.fechaFin,"onUpdate:modelValue":e[1]||(e[1]=r=>n.filters.fechaFin=r),label:"Fecha fin",type:"date",dense:"",outlined:"",disable:n.loading},null,8,["modelValue","disable"])]),a("div",z,[s(j,{modelValue:n.filters.incluirAnuladas,"onUpdate:modelValue":e[2]||(e[2]=r=>n.filters.incluirAnuladas=r),label:"Incluir anuladas (productos)",disable:n.loading},null,8,["modelValue","disable"]),s(w,{loading:n.loading,color:"primary",icon:"refresh",label:"Actualizar","no-caps":"",onClick:c.loadAll},null,8,["loading","onClick"])])]),_:1})]),_:1})]),(m(!0),v(A,null,C(c.kpis,r=>(m(),v("div",{class:"col-12 col-sm-6 col-md-3",key:r.key},[s(p,{class:"kpi-card shadow-2"},{default:l(()=>[s(d,null,{default:l(()=>[a("div",q,[a("div",null,[a("div",E,h(r.label),1),a("div",L,h(r.formatter(r.value)),1)]),s(R,{icon:r.icon,size:"44px",color:r.color,"text-color":"white"},null,8,["icon","color"])])]),_:2},1024),s(g),s(d,{class:"text-caption text-grey-7"},{default:l(()=>[f(h(r.help),1)]),_:2},1024)]),_:2},1024)]))),128)),a("div",M,[s(p,{class:"shadow-2"},{default:l(()=>[s(d,{class:"row items-center justify-between"},{default:l(()=>[e[6]||(e[6]=a("div",{class:"text-subtitle1"},"Caja por día",-1)),s(b,{color:"grey-7","text-color":"white"},{default:l(()=>e[5]||(e[5]=[f("Monto real")])),_:1})]),_:1}),s(g),s(d,null,{default:l(()=>[c.seriesCaja.length?(m(),_(u,{key:0,height:"320",type:"line",options:n.chartCaja.options,series:c.seriesCaja},null,8,["options","series"])):(m(),v("div",O,"Sin datos para el rango seleccionado"))]),_:1})]),_:1})]),a("div",U,[s(p,{class:"shadow-2"},{default:l(()=>[s(d,{class:"row items-center justify-between"},{default:l(()=>[e[8]||(e[8]=a("div",{class:"text-subtitle1"},"Ingresos: Ventas vs Reservas",-1)),s(b,{color:"grey-7","text-color":"white"},{default:l(()=>e[7]||(e[7]=[f("Periodo")])),_:1})]),_:1}),s(g),s(d,null,{default:l(()=>[s(u,{height:"320",type:"donut",options:n.chartIngresos.options,series:c.seriesIngresos},null,8,["options","series"])]),_:1})]),_:1})]),a("div",Y,[s(p,{class:"shadow-2"},{default:l(()=>[s(d,{class:"row items-center justify-between"},{default:l(()=>[e[10]||(e[10]=a("div",{class:"text-subtitle1"},"Reservas por estado",-1)),s(b,{color:"grey-7","text-color":"white"},{default:l(()=>e[9]||(e[9]=[f("Conteo")])),_:1})]),_:1}),s(g),s(d,null,{default:l(()=>[s(u,{height:"320",type:"donut",options:n.chartReservas.options,series:c.seriesReservas},null,8,["options","series"])]),_:1})]),_:1})]),a("div",H,[s(p,{class:"shadow-2"},{default:l(()=>[s(d,{class:"row items-center justify-between"},{default:l(()=>[e[12]||(e[12]=a("div",{class:"text-subtitle1"},"Top productos vendidos",-1)),s(b,{color:"grey-7","text-color":"white"},{default:l(()=>e[11]||(e[11]=[f("Cantidad")])),_:1})]),_:1}),s(g),s(d,null,{default:l(()=>[s(u,{height:"320",type:"bar",options:n.chartTopProd.options,series:c.seriesTopProd},null,8,["options","series"])]),_:1})]),_:1})]),a("div",Z,[s(p,{class:"shadow-2"},{default:l(()=>[s(d,{class:"row items-center justify-between"},{default:l(()=>[e[13]||(e[13]=a("div",{class:"text-subtitle1"},"Últimas reservas",-1)),s(w,{flat:"",dense:"",icon:"open_in_new",label:"Ver todas","no-caps":"",onClick:e[3]||(e[3]=r=>t.$router.push("/reservas"))})]),_:1}),s(g),s(d,null,{default:l(()=>[s(k,{flat:"",bordered:"",dense:"",class:"bg-white"},{default:l(()=>[e[14]||(e[14]=a("thead",null,[a("tr",null,[a("th",null,"Fecha"),a("th",null,"Nombre"),a("th",null,"Personas"),a("th",null,"Estado"),a("th",null,"Agencia"),a("th",null,"Usuario")])],-1)),a("tbody",null,[(m(!0),v(A,null,C(n.ultimasReservas,r=>(m(),v("tr",{key:r.id},[a("td",null,h(c.formatDate(r.fecha)),1),a("td",null,h(r.nombre),1),a("td",G,h(r.numero_personas),1),a("td",null,[s(y,{dense:"",square:"",color:c.estadoColor(r.estado),"text-color":"black"},{default:l(()=>[f(h(r.estado),1)]),_:2},1032,["color"])]),a("td",null,[s(y,{dense:"",outline:"",color:r.agencia==="Ayacucho"?"deep-orange":"indigo","text-color":r.agencia==="Ayacucho"?"deep-orange-10":"indigo-10"},{default:l(()=>[f(h(r.agencia||"—"),1)]),_:2},1032,["color","text-color"])]),a("td",null,[s(y,{dense:"",outline:""},{default:l(()=>[f(h(r.user&&r.user.name?r.user.name:"—"),1)]),_:2},1024)])]))),128))])]),_:1})]),_:1})]),_:1})])])]),_:1})}const ae=V(T,[["render",J],["__scopeId","data-v-e160a3f5"]]);export{ae as default};
