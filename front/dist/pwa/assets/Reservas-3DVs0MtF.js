import{j as ae,k as C,l as le,ab as te,g as oe,r as d,V as se,c as P,o as m,w as i,a as o,Q as K,e as U,b as v,an as j,f as q,Z as w,t as f,a0 as O,a1 as b,a2 as R,a3 as z,a4 as G,h as re,au as ne,ap as ue,W as ie}from"./index-BCEHSGBj.js";import{Q as J,a as ce}from"./QTh-BT3XeZ3P.js";import{Q as ve}from"./QMarkupTable-CgVrH0X8.js";import{Q as de}from"./QSpace-BXiu2jDa.js";import{Q as me}from"./QForm-Dun49YRB.js";import{Q as fe}from"./QPage-B9wyOFgf.js";import{C as ge}from"./ClosePopup-DjIS63nP.js";import{h as E}from"./moment-C5S46NFB.js";const be=["top","middle","bottom"],F=ae({name:"QBadge",props:{color:String,textColor:String,floating:Boolean,transparent:Boolean,multiLine:Boolean,outline:Boolean,rounded:Boolean,label:[Number,String],align:{type:String,validator:r=>be.includes(r)}},setup(r,{slots:c}){const k=C(()=>r.align!==void 0?{verticalAlign:r.align}:null),h=C(()=>{const S=r.outline===!0&&r.color||r.textColor;return`q-badge flex inline items-center no-wrap q-badge--${r.multiLine===!0?"multi":"single"}-line`+(r.outline===!0?" q-badge--outline":r.color!==void 0?` bg-${r.color}`:"")+(S!==void 0?` text-${S}`:"")+(r.floating===!0?" q-badge--floating":"")+(r.rounded===!0?" q-badge--rounded":"")+(r.transparent===!0?" q-badge--transparent":"")});return()=>le("div",{class:h.value,style:k.value,role:"status","aria-label":r.label},te(c.default,r.label!==void 0?[r.label]:[]))}}),pe={class:"row"},$e={class:"col-6 col-md-2"},ye={class:"col-6 col-md-2 flex flex-center"},ke={class:"col-6 col-md-2"},he={class:"col-6 col-md-3 text-right"},Se={class:"scroll-body"},_e=["rowspan","onClick"],Ve={key:0},we={key:1},Ce={class:"text-bold"},De={__name:"Reservas",setup(r){const{proxy:c}=oe(),k=d(E().format("YYYY-MM-DD")),h=d([]),S=d([]),n=d({}),s=d({}),_=d(0),Q=d(!1),V=d(""),p=d(1),$=d(0),M=d(""),y=d(!1),T=C(()=>{const t=Math.floor(_.value/60),a=_.value%60;return`${String(t).padStart(2,"0")}:${String(a).padStart(2,"0")}`}),B=C(()=>_.value/30*5*(p.value||1));se(()=>{for(let t=0;t<20;t++)h.value.push({sala:"Sala "+(t+1)});for(let t=8;t<23;t++){let a=`${t}:00`,e=`${t}:30`;S.value.push({hora:`${a} a ${e}`}),a=`${t}:30`,e=`${t+1}:00`,S.value.push({hora:`${a} a ${e}`})}H(),D(),c.$store.socketReservas||(c.$socket.on("reservas",()=>{D()}),c.$store.socketReservas=!0)});function D(){y.value=!0,c.$axios.get("/reservas",{params:{fecha:k.value}}).then(t=>{s.value=t.data||{},console.log("Reservas cargadas:",s.value)}).catch(t=>{c.$alert.error("Error al obtener reservas")}).finally(()=>{y.value=!1})}function L(){n.value={},_.value=0,V.value="",p.value=1,$.value=0,M.value=""}const Y=C(()=>Object.keys(n.value).length===0?"-":Object.values(n.value).map(a=>E(a,"H:mm")).sort((a,e)=>a.diff(e))[0].format("H:mm")),A=C(()=>{if(Object.keys(n.value).length===0)return"-";const t=Object.values(n.value).map(e=>E(e,"H:mm")).sort((e,l)=>e.diff(l));return t[t.length-1].add(30,"minutes").format("H:mm")});function W(){if(_.value===0){c.$alert.error("Por favor","selecciona al menos 30 minutos.");return}Q.value=!0,V.value="",p.value=2,$.value=20,M.value=""}const Z=(t,a)=>{const e=`${t}-${a}`,l=`${t-1}-${a}`;return s.value[e]?!(t>0&&s.value[l]&&s.value[l].nombre===s.value[e].nombre):!0},X=(t,a)=>{const e=`${t}-${a}`;if(!s.value[e])return 1;let l=1;for(;s.value[`${t+l}-${a}`]&&s.value[`${t+l}-${a}`].nombre===s.value[e].nombre;)l++;return l},x=(t,a,e)=>{const l=`${t}-${a}`;if(s.value[l])return;if(Object.keys(n.value).length===0){n.value[l]=e,H();return}const N=new Set(Object.keys(n.value).map(g=>g.split("-")[1]));if(N.size>0&&!N.has(String(a))){c.$alert.error("Debes seleccionar en la misma sala.");return}const u=Object.keys(n.value).map(g=>parseInt(g.split("-")[0])).sort((g,ee)=>g-ee);if(u.length>0){const g=u[u.length-1];if(t!==g+1){c.$alert.error("Debes seleccionar horarios consecutivos.");return}}n.value[l]?delete n.value[l]:n.value[l]=e,H()},H=()=>{_.value=Object.keys(n.value).length*30},I=()=>{Object.keys(n.value).forEach(l=>{s.value[l]={nombre:V.value,personas:p.value,color:"yellow"}});const a=Object.keys(n.value)[0].split("-")[1],e=h.value[a]?.sala||"Desconocida";y.value=!0,c.$axios.post("/reservas",{nombre:V.value,numero_personas:p.value,observaciones:M.value,json:JSON.stringify(n.value),sala:e,total:B.value,adelanto:$.value,tiempo:T.value,horario:`${Y.value} - ${A.value}`,fecha:k.value}).then(l=>{c.$alert.success("Reserva confirmada","Reserva"),L(),c.$socket.emit("reservas"),Q.value=!1}).catch(l=>{c.$alert.error(l.response.data.message,"Error al confirmar reserva")}).finally(()=>{y.value=!1})};return(t,a)=>(m(),P(fe,{class:"q-pa-xs"},{default:i(()=>[o(K,{flat:"",bordered:""},{default:i(()=>[o(U,{class:"q-pa-xs"},{default:i(()=>[v("div",pe,[v("div",$e,[o(j,{modelValue:k.value,"onUpdate:modelValue":[a[0]||(a[0]=e=>k.value=e),D],type:"date",label:"Fecha",dense:"",outlined:""},null,8,["modelValue"])]),v("div",ye,[o(q,{color:"green",label:"Reservar",onClick:W,"no-caps":"",icon:"save",size:"11px",loading:y.value},null,8,["loading"])]),v("div",ke,[o(F,{color:"primary",class:"q-pa-sm"},{default:i(()=>[w(" Tiempo Seleccionado: "+f(T.value),1)]),_:1})]),v("div",he,[Object.keys(n.value).length>0?(m(),P(q,{key:0,color:"red",label:"Limpiar",onClick:L,"no-caps":"",icon:"clear",size:"11px"})):O("",!0)]),a[7]||(a[7]=v("div",{class:"col-6 col-md-3 text-right"},null,-1))]),o(ve,{"wrap-cells":"",dense:"",bordered:"",flat:"",separator:"cell",class:"tabla-reservas"},{default:i(()=>[v("thead",null,[v("tr",null,[o(J,{class:"bg-grey text-white"},{default:i(()=>a[8]||(a[8]=[w("Hora")])),_:1}),(m(!0),b(R,null,z(h.value,e=>(m(),P(J,{class:"bg-primary text-white",key:e.sala},{default:i(()=>[w(f(e.sala),1)]),_:2},1024))),128))])]),v("tbody",Se,[(m(!0),b(R,null,z(S.value,(e,l)=>(m(),b("tr",{key:l},[o(ce,{style:{"font-size":"10px",padding:"0",margin:"0",width:"70px"}},{default:i(()=>[w(f(e.hora),1)]),_:2},1024),(m(!0),b(R,null,z(h.value,(N,u)=>(m(),b(R,{key:u},[Z(l,u)?(m(),b("td",{key:0,rowspan:X(l,u),class:G([{"bg-green text-white":n.value[`${l}-${u}`]&&!s.value[`${l}-${u}`],"bg-red text-white":s.value[`${l}-${u}`]?.color==="red","bg-yellow text-black":s.value[`${l}-${u}`]?.color==="yellow","bg-grey-3":!n.value[`${l}-${u}`]&&!s.value[`${l}-${u}`]},"text-center cursor-pointer"]),onClick:g=>x(l,u,e.hora)},[s.value[`${l}-${u}`]?(m(),b("div",Ve,f(s.value[`${l}-${u}`].nombre),1)):O("",!0),s.value[`${l}-${u}`]&&s.value[`${l}-${u}`].fecha_confirmacion?(m(),b("div",we,f(s.value[`${l}-${u}`].fecha_confirmacion.substring(11,16)),1)):O("",!0)],10,_e)):O("",!0)],64))),128))]))),128))])]),_:1})]),_:1})]),_:1}),o(re,{modelValue:Q.value,"onUpdate:modelValue":a[6]||(a[6]=e=>Q.value=e)},{default:i(()=>[o(K,{style:{"min-width":"250px"}},{default:i(()=>[o(U,{class:"q-pb-none row items-center"},{default:i(()=>[a[9]||(a[9]=v("div",{class:"text-h6"},"Reservar Sala",-1)),o(de),o(q,{flat:"",dense:"",round:"",icon:"close",class:"q-ml-auto",onClick:a[1]||(a[1]=e=>Q.value=!1)})]),_:1}),o(U,null,{default:i(()=>[o(me,{onSubmit:ne(I,["prevent"])},{default:i(()=>[o(j,{modelValue:V.value,"onUpdate:modelValue":a[2]||(a[2]=e=>V.value=e),label:"Nombre",dense:"",outlined:"",class:"",rules:[e=>!!e||"Por favor, ingresa un nombre."]},null,8,["modelValue","rules"]),o(j,{modelValue:p.value,"onUpdate:modelValue":a[3]||(a[3]=e=>p.value=e),modelModifiers:{number:!0},type:"number",label:"Número de Personas",dense:"",outlined:"",class:"",rules:[e=>e>0||"Por favor, ingresa un número válido."]},null,8,["modelValue","rules"]),o(j,{modelValue:$.value,"onUpdate:modelValue":a[4]||(a[4]=e=>$.value=e),modelModifiers:{number:!0},type:"number",label:"Adelanto",dense:"",outlined:"",class:"",rules:[e=>e>=0||"Por favor, ingresa un número válido."]},null,8,["modelValue","rules"]),o(j,{modelValue:M.value,"onUpdate:modelValue":a[5]||(a[5]=e=>M.value=e),label:"Observación",dense:"",outlined:"",class:"",hint:"",type:"textarea"},null,8,["modelValue"]),v("div",null,[o(F,{color:"indigo",class:"q-pa-sm"},{default:i(()=>[w(" Horario Seleccionado: Desde "+f(Y.value)+" hasta "+f(A.value),1)]),_:1})]),o(F,{color:"blue",class:"q-pa-sm"},{default:i(()=>[w(" Tiempo Total: "+f(T.value),1)]),_:1}),v("div",Ce," Monto Total: "+f(B.value)+" Bs ",1),v("div",{class:G({"text-red":$.value>B.value})}," Saldo: "+f(B.value-$.value),3),o(ue,{align:"right"},{default:i(()=>[ie(o(q,{flat:"",label:"Cancelar","no-caps":"",loading:y.value},null,8,["loading"]),[[ge]]),o(q,{color:"green",label:"Confirmar","no-caps":"",type:"submit",loading:y.value},null,8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}};export{De as default};
