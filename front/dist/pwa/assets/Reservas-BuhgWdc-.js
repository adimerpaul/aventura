import{v as ae,x as C,j as te,ad as oe,g as se,r as d,l as re,c as U,o as m,w as i,a as o,Q as A,e as z,b as v,ap as B,f as M,a0 as j,t as f,a3 as T,a4 as b,a5 as D,a6 as E,a7 as K,h as ne,aw as ue,aq as ie,ar as ce,Z as ve}from"./index-C7TDVlhA.js";import{Q as G,a as de}from"./QTh-B7Ru0A7k.js";import{Q as me}from"./QMarkupTable-DxRm-XRG.js";import{Q as fe}from"./QSpace-BcvqI9OC.js";import{Q as ge}from"./QForm-PMUZoa6V.js";import{Q as be}from"./QPage-BljVUeCH.js";import{C as pe}from"./ClosePopup-Ai7ETFMl.js";import{h as F}from"./moment-C5S46NFB.js";const $e=["top","middle","bottom"],J=ae({name:"QBadge",props:{color:String,textColor:String,floating:Boolean,transparent:Boolean,multiLine:Boolean,outline:Boolean,rounded:Boolean,label:[Number,String],align:{type:String,validator:r=>$e.includes(r)}},setup(r,{slots:c}){const h=C(()=>r.align!==void 0?{verticalAlign:r.align}:null),S=C(()=>{const V=r.outline===!0&&r.color||r.textColor;return`q-badge flex inline items-center no-wrap q-badge--${r.multiLine===!0?"multi":"single"}-line`+(r.outline===!0?" q-badge--outline":r.color!==void 0?` bg-${r.color}`:"")+(V!==void 0?` text-${V}`:"")+(r.floating===!0?" q-badge--floating":"")+(r.rounded===!0?" q-badge--rounded":"")+(r.transparent===!0?" q-badge--transparent":"")});return()=>te("div",{class:S.value,style:h.value,role:"status","aria-label":r.label},oe(c.default,r.label!==void 0?[r.label]:[]))}}),ye={class:"row"},ke={class:"col-6 col-md-2"},he={class:"col-6 col-md-2 flex flex-center"},Se={class:"col-6 col-md-2"},Ve={class:"col-6 col-md-3 text-right"},_e={class:"scroll-body"},we=["rowspan","onClick"],Ce={key:0},Qe={key:1},qe={class:"text-bold q-mt-md text-blue bg-grey-3"},Be={class:"text-bold"},Me={class:"text-red text-bold"},Ue={__name:"Reservas",setup(r){const{proxy:c}=se(),h=d(F().format("YYYY-MM-DD")),S=d([]),V=d([]),n=d({}),s=d({}),_=d(0),Q=d(!1),w=d(""),p=d(1),$=d(0),q=d(""),y=d(!1),k=d(!1),H=C(()=>{const t=Math.floor(_.value/60),l=_.value%60;return`${String(t).padStart(2,"0")}:${String(l).padStart(2,"0")}`}),O=C(()=>_.value/30*5*(p.value||1));re(()=>{for(let t=0;t<20;t++)S.value.push({sala:"Sala "+(t+1)});for(let t=8;t<23;t++){let l=`${t}:00`,e=`${t}:30`;V.value.push({hora:`${l}-${e}`}),l=`${t}:30`,e=`${t+1}:00`,V.value.push({hora:`${l}-${e}`})}N(),R(),c.$store.socketReservas||(c.$socket.on("reservas",()=>{R()}),c.$store.socketReservas=!0)});function R(){y.value=!0,s.value={},c.$axios.get("/reservas",{params:{fecha:h.value}}).then(t=>{s.value=t.data||{},console.log("Reservas cargadas:",s.value)}).catch(t=>{c.$alert.error("Error al obtener reservas")}).finally(()=>{y.value=!1})}function L(){n.value={},_.value=0,w.value="",p.value=1,$.value=0,q.value=""}const Y=C(()=>Object.keys(n.value).length===0?"-":Object.values(n.value).map(l=>F(l,"H:mm")).sort((l,e)=>l.diff(e))[0].format("H:mm")),x=C(()=>{if(Object.keys(n.value).length===0)return"-";const t=Object.values(n.value).map(e=>F(e,"H:mm")).sort((e,a)=>e.diff(a));return t[t.length-1].add(30,"minutes").format("H:mm")});function Z(){if(_.value===0){c.$alert.error("Por favor","selecciona al menos 30 minutos.");return}Q.value=!0,w.value="",p.value=2,$.value=0,q.value="",k.value=!1}const W=(t,l)=>{const e=`${t}-${l}`,a=`${t-1}-${l}`;return s.value[e]?!(t>0&&s.value[a]&&s.value[a].nombre===s.value[e].nombre):!0},X=(t,l)=>{const e=`${t}-${l}`;if(!s.value[e])return 1;let a=1;for(;s.value[`${t+a}-${l}`]&&s.value[`${t+a}-${l}`].nombre===s.value[e].nombre;)a++;return a},I=(t,l,e)=>{const a=`${t}-${l}`;if(s.value[a])return;if(Object.keys(n.value).length===0){n.value[a]=e,N();return}const P=new Set(Object.keys(n.value).map(g=>g.split("-")[1]));if(P.size>0&&!P.has(String(l))){c.$alert.error("Debes seleccionar en la misma sala.");return}const u=Object.keys(n.value).map(g=>parseInt(g.split("-")[0])).sort((g,le)=>g-le);if(u.length>0){const g=u[u.length-1];if(t!==g+1){c.$alert.error("Debes seleccionar horarios consecutivos.");return}}n.value[a]?delete n.value[a]:n.value[a]=e,N()},N=()=>{_.value=Object.keys(n.value).length*30},ee=()=>{Object.keys(n.value).forEach(a=>{s.value[a]={nombre:w.value,personas:p.value,color:"yellow"}});const l=Object.keys(n.value)[0].split("-")[1],e=S.value[l]?.sala||"Desconocida";y.value=!0,c.$axios.post("/reservas",{nombre:w.value,numero_personas:p.value,observaciones:q.value,json:JSON.stringify(n.value),sala:e,total:O.value,adelanto:$.value,tiempo:H.value,horario:`${Y.value} - ${x.value}`,fecha:h.value,directo:k.value}).then(a=>{c.$alert.success("Reserva confirmada","Reserva"),L(),R(),c.$socket.emit("reservas"),Q.value=!1}).catch(a=>{c.$alert.error(a.response.data.message,"Error al confirmar reserva")}).finally(()=>{y.value=!1})};return(t,l)=>(m(),U(be,{class:"q-pa-xs"},{default:i(()=>[o(A,{flat:"",bordered:""},{default:i(()=>[o(z,{class:"q-pa-xs"},{default:i(()=>[v("div",ye,[v("div",ke,[o(B,{modelValue:h.value,"onUpdate:modelValue":[l[0]||(l[0]=e=>h.value=e),R],type:"date",label:"Fecha",dense:"",outlined:""},null,8,["modelValue"])]),v("div",he,[o(M,{color:"green",label:"Reservar",onClick:Z,"no-caps":"",icon:"save",size:"11px",loading:y.value},null,8,["loading"])]),v("div",Se,[o(J,{color:"indigo",class:"q-pa-sm"},{default:i(()=>[j(" Tiempo Seleccionado: "+f(H.value),1)]),_:1})]),v("div",Ve,[Object.keys(n.value).length>0?(m(),U(M,{key:0,color:"red",label:"Limpiar",onClick:L,"no-caps":"",icon:"clear",size:"11px"})):T("",!0)]),l[9]||(l[9]=v("div",{class:"col-6 col-md-3 text-right"},null,-1))]),o(me,{"wrap-cells":"",dense:"",bordered:"",flat:"",separator:"cell",class:"tabla-reservas"},{default:i(()=>[v("thead",null,[v("tr",null,[o(G,{class:"bg-grey text-white sticky-hora"},{default:i(()=>l[10]||(l[10]=[j("Hora")])),_:1}),(m(!0),b(D,null,E(S.value,e=>(m(),U(G,{class:"bg-primary text-white",key:e.sala},{default:i(()=>[j(f(e.sala),1)]),_:2},1024))),128))])]),v("tbody",_e,[(m(!0),b(D,null,E(V.value,(e,a)=>(m(),b("tr",{key:a},[o(de,{class:"sticky-hora",style:{padding:"0",margin:"0",border:"0"}},{default:i(()=>[j(f(e.hora),1)]),_:2},1024),(m(!0),b(D,null,E(S.value,(P,u)=>(m(),b(D,{key:u},[W(a,u)?(m(),b("td",{key:0,rowspan:X(a,u),class:K([{"bg-green text-white":n.value[`${a}-${u}`]&&!s.value[`${a}-${u}`],"bg-red text-white":s.value[`${a}-${u}`]?.color==="red","bg-yellow text-black":s.value[`${a}-${u}`]?.color==="yellow","bg-grey-3":!n.value[`${a}-${u}`]&&!s.value[`${a}-${u}`]},"text-center cursor-pointer"]),onClick:g=>I(a,u,e.hora)},[s.value[`${a}-${u}`]?(m(),b("div",Ce,f(s.value[`${a}-${u}`].nombre),1)):T("",!0),s.value[`${a}-${u}`]&&s.value[`${a}-${u}`].fecha_confirmacion?(m(),b("div",Qe,f(s.value[`${a}-${u}`].fecha_confirmacion.substring(11,16)),1)):T("",!0)],10,we)):T("",!0)],64))),128))]))),128))])]),_:1})]),_:1})]),_:1}),o(ne,{modelValue:Q.value,"onUpdate:modelValue":l[8]||(l[8]=e=>Q.value=e)},{default:i(()=>[o(A,{style:{"min-width":"250px"}},{default:i(()=>[o(z,{class:"q-pb-none row items-center"},{default:i(()=>[l[11]||(l[11]=v("div",{class:"text-h6"},"Reservar Sala",-1)),o(fe),o(M,{flat:"",dense:"",round:"",icon:"close",class:"q-ml-auto",onClick:l[1]||(l[1]=e=>Q.value=!1)})]),_:1}),o(z,null,{default:i(()=>[o(ge,{onSubmit:ue(ee,["prevent"])},{default:i(()=>[o(B,{modelValue:w.value,"onUpdate:modelValue":l[2]||(l[2]=e=>w.value=e),label:"Nombre",dense:"",outlined:"",class:"",rules:[e=>!!e||"Por favor, ingresa un nombre."]},null,8,["modelValue","rules"]),o(B,{modelValue:p.value,"onUpdate:modelValue":l[3]||(l[3]=e=>p.value=e),modelModifiers:{number:!0},type:"number",label:"Número de Personas",dense:"",outlined:"",class:"",rules:[e=>e>0||"Por favor, ingresa un número válido."]},null,8,["modelValue","rules"]),o(B,{modelValue:$.value,"onUpdate:modelValue":l[4]||(l[4]=e=>$.value=e),modelModifiers:{number:!0},type:"number",label:"Adelanto",dense:"",outlined:"",class:"",rules:[e=>e>=0||"Por favor, ingresa un número válido."]},null,8,["modelValue","rules"]),o(B,{modelValue:q.value,"onUpdate:modelValue":l[5]||(l[5]=e=>q.value=e),label:"Observación",dense:"",outlined:"",type:"textarea"},null,8,["modelValue"]),o(ie,{modelValue:k.value,"onUpdate:modelValue":[l[6]||(l[6]=e=>k.value=e),l[7]||(l[7]=e=>$.value=O.value)],label:k.value?"Venta Directa":"Reserva",class:K({"text-primary":k.value,"text-orange":!k.value})},null,8,["modelValue","label","class"]),v("div",null,[o(J,{color:"indigo",class:"q-pa-sm"},{default:i(()=>[j(" Horario Seleccionado: Desde "+f(Y.value)+" hasta "+f(x.value),1)]),_:1})]),v("div",qe," Tiempo Total: "+f(H.value),1),v("div",Be," Monto Total: "+f(O.value)+" Bs ",1),v("div",Me," Saldo: "+f(O.value-$.value)+" Bs ",1),o(ce,{align:"right"},{default:i(()=>[ve(o(M,{flat:"",label:"Cancelar","no-caps":"",loading:y.value},null,8,["loading"]),[[pe]]),o(M,{color:"green",label:"Confirmar","no-caps":"",type:"submit",loading:y.value},null,8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}};export{Ue as default};
