import{v as te,x as Q,j as oe,ad as re,g as se,r as d,l as ne,c as z,o as m,w as c,a as o,Q as K,e as E,b as v,ap as B,f as M,a0 as O,t as f,a3 as H,a4 as b,a5 as N,a6 as L,a7 as G,h as ue,aw as ie,aq as ce,ar as ve,Z as de}from"./index-gHp625-a.js";import{Q as J,a as me}from"./QTh-Cq_YaeXE.js";import{Q as fe}from"./QMarkupTable-BeLlV9km.js";import{Q as ge}from"./QSpace-1am9F43B.js";import{Q as be}from"./QForm-DX3Dsrq9.js";import{Q as $e}from"./QPage-CmNNLiaB.js";import{C as pe}from"./ClosePopup-6oXliESD.js";import{h as x}from"./moment-C5S46NFB.js";const ye=["top","middle","bottom"],Z=te({name:"QBadge",props:{color:String,textColor:String,floating:Boolean,transparent:Boolean,multiLine:Boolean,outline:Boolean,rounded:Boolean,label:[Number,String],align:{type:String,validator:s=>ye.includes(s)}},setup(s,{slots:i}){const h=Q(()=>s.align!==void 0?{verticalAlign:s.align}:null),S=Q(()=>{const V=s.outline===!0&&s.color||s.textColor;return`q-badge flex inline items-center no-wrap q-badge--${s.multiLine===!0?"multi":"single"}-line`+(s.outline===!0?" q-badge--outline":s.color!==void 0?` bg-${s.color}`:"")+(V!==void 0?` text-${V}`:"")+(s.floating===!0?" q-badge--floating":"")+(s.rounded===!0?" q-badge--rounded":"")+(s.transparent===!0?" q-badge--transparent":"")});return()=>oe("div",{class:S.value,style:h.value,role:"status","aria-label":s.label},re(i.default,s.label!==void 0?[s.label]:[]))}}),ke={class:"row"},he={class:"col-6 col-md-2"},Se={class:"col-6 col-md-2 flex flex-center"},Ve={class:"col-6 col-md-2"},_e={class:"col-6 col-md-3 text-right"},we={class:"scroll-body"},Ce=["rowspan","onClick"],Qe={key:0},je={key:1},qe={class:"text-bold q-mt-md text-blue bg-grey-3"},Be={class:"text-bold"},Me={class:"text-red text-bold"},ze={__name:"Reservas",setup(s){const{proxy:i}=se(),h=d(x().format("YYYY-MM-DD")),S=d([]),V=d([]),n=d({}),r=d({}),_=d(0),j=d(!1),w=d(""),$=d(1),p=d(0),q=d(""),g=d(!1),y=d(!1),P=Q(()=>{const t=Math.floor(_.value/60),a=_.value%60;return`${String(t).padStart(2,"0")}:${String(a).padStart(2,"0")}`}),R=Q(()=>_.value/30*5*($.value||1));ne(()=>{for(let t=0;t<20;t++)S.value.push({sala:"Sala "+(t+1)});for(let t=8;t<23;t++){let a=`${t}:00`,e=`${t}:30`;V.value.push({hora:`${a}-${e}`}),a=`${t}:30`,e=`${t+1}:00`,V.value.push({hora:`${a}-${e}`})}U(),T(),i.$store.socketReservas||(i.$socket.on("reservas",()=>{T()}),i.$store.socketReservas=!0)});function T(){g.value=!0,r.value={},i.$axios.get("/reservas",{params:{fecha:h.value}}).then(t=>{r.value=t.data||{},console.log("Reservas cargadas:",r.value)}).catch(t=>{i.$alert.error("Error al obtener reservas")}).finally(()=>{g.value=!1})}function F(){n.value={},_.value=0,w.value="",$.value=1,p.value=0,q.value=""}const Y=Q(()=>Object.keys(n.value).length===0?"-":Object.values(n.value).map(a=>x(a,"H:mm")).sort((a,e)=>a.diff(e))[0].format("H:mm")),A=Q(()=>{if(Object.keys(n.value).length===0)return"-";const t=Object.values(n.value).map(e=>x(e,"H:mm")).sort((e,l)=>e.diff(l));return t[t.length-1].add(30,"minutes").format("H:mm")});function W(){if(_.value===0){i.$alert.error("Por favor","selecciona al menos 30 minutos.");return}j.value=!0,w.value="",$.value=2,p.value=0,q.value="",y.value=!1}const X=(t,a)=>{const e=`${t}-${a}`,l=`${t-1}-${a}`;return r.value[e]?!(t>0&&r.value[l]&&r.value[l].nombre===r.value[e].nombre):!0},I=(t,a)=>{const e=`${t}-${a}`;if(!r.value[e])return 1;let l=1;for(;r.value[`${t+l}-${a}`]&&r.value[`${t+l}-${a}`].nombre===r.value[e].nombre;)l++;return l},ee=(t,a,e)=>{g.value=!0,i.$axios.get("/verificarCaja").then(l=>{if(console.log(l.data.estado),l.data.estado==="cerrada")return i.$alert.error("La caja está cerrada, no se pueden realizar reservas"),!1;const C=`${t}-${a}`;if(r.value[C])return;if(Object.keys(n.value).length===0){n.value[C]=e,U();return}const u=new Set(Object.keys(n.value).map(k=>k.split("-")[1]));if(u.size>0&&!u.has(String(a))){i.$alert.error("Debes seleccionar en la misma sala.");return}const D=Object.keys(n.value).map(k=>parseInt(k.split("-")[0])).sort((k,le)=>k-le);if(D.length>0){const k=D[D.length-1];if(t!==k+1){i.$alert.error("Debes seleccionar horarios consecutivos.");return}}n.value[C]?delete n.value[C]:n.value[C]=e,U()}).catch(l=>{i.$alert.error("Error al obtener reservas")}).finally(()=>{g.value=!1})},U=()=>{_.value=Object.keys(n.value).length*30},ae=()=>{Object.keys(n.value).forEach(l=>{r.value[l]={nombre:w.value,personas:$.value,color:"yellow"}});const a=Object.keys(n.value)[0].split("-")[1],e=S.value[a]?.sala||"Desconocida";g.value=!0,i.$axios.post("/reservas",{nombre:w.value,numero_personas:$.value,observaciones:q.value,json:JSON.stringify(n.value),sala:e,total:R.value,adelanto:p.value,tiempo:P.value,horario:`${Y.value} - ${A.value}`,fecha:h.value,directo:y.value}).then(l=>{i.$alert.success("Reserva confirmada","Reserva"),F(),T(),i.$socket.emit("reservas"),j.value=!1}).catch(l=>{i.$alert.error(l.response.data.message,"Error al confirmar reserva")}).finally(()=>{g.value=!1})};return(t,a)=>(m(),z($e,{class:"q-pa-xs"},{default:c(()=>[o(K,{flat:"",bordered:""},{default:c(()=>[o(E,{class:"q-pa-xs"},{default:c(()=>[v("div",ke,[v("div",he,[o(B,{modelValue:h.value,"onUpdate:modelValue":[a[0]||(a[0]=e=>h.value=e),T],type:"date",label:"Fecha",dense:"",outlined:""},null,8,["modelValue"])]),v("div",Se,[o(M,{color:"green",label:"Reservar",onClick:W,"no-caps":"",icon:"save",size:"11px",loading:g.value},null,8,["loading"])]),v("div",Ve,[o(Z,{color:"indigo",class:"q-pa-sm"},{default:c(()=>[O(" Tiempo Seleccionado: "+f(P.value),1)]),_:1})]),v("div",_e,[Object.keys(n.value).length>0?(m(),z(M,{key:0,color:"red",label:"Limpiar",onClick:F,"no-caps":"",icon:"clear",size:"11px"})):H("",!0)]),a[9]||(a[9]=v("div",{class:"col-6 col-md-3 text-right"},null,-1))]),o(fe,{"wrap-cells":"",dense:"",bordered:"",flat:"",separator:"cell",class:"tabla-reservas"},{default:c(()=>[v("thead",null,[v("tr",null,[o(J,{class:"bg-grey text-white sticky-hora"},{default:c(()=>a[10]||(a[10]=[O("Hora")])),_:1}),(m(!0),b(N,null,L(S.value,e=>(m(),z(J,{class:"bg-primary text-white",key:e.sala},{default:c(()=>[O(f(e.sala),1)]),_:2},1024))),128))])]),v("tbody",we,[(m(!0),b(N,null,L(V.value,(e,l)=>(m(),b("tr",{key:l},[o(me,{class:"sticky-hora",style:{padding:"0",margin:"0",border:"0"}},{default:c(()=>[O(f(e.hora),1)]),_:2},1024),(m(!0),b(N,null,L(S.value,(C,u)=>(m(),b(N,{key:u},[X(l,u)?(m(),b("td",{key:0,rowspan:I(l,u),class:G([{"bg-green text-white":n.value[`${l}-${u}`]&&!r.value[`${l}-${u}`],"bg-red text-white":r.value[`${l}-${u}`]?.color==="red","bg-yellow text-black":r.value[`${l}-${u}`]?.color==="yellow","bg-grey-3":!n.value[`${l}-${u}`]&&!r.value[`${l}-${u}`]},"text-center cursor-pointer"]),onClick:D=>ee(l,u,e.hora)},[r.value[`${l}-${u}`]?(m(),b("div",Qe,f(r.value[`${l}-${u}`].nombre),1)):H("",!0),r.value[`${l}-${u}`]&&r.value[`${l}-${u}`].fecha_confirmacion?(m(),b("div",je,f(r.value[`${l}-${u}`].fecha_confirmacion.substring(11,16)),1)):H("",!0)],10,Ce)):H("",!0)],64))),128))]))),128))])]),_:1})]),_:1})]),_:1}),o(ue,{modelValue:j.value,"onUpdate:modelValue":a[8]||(a[8]=e=>j.value=e)},{default:c(()=>[o(K,{style:{"min-width":"250px"}},{default:c(()=>[o(E,{class:"q-pb-none row items-center"},{default:c(()=>[a[11]||(a[11]=v("div",{class:"text-h6"},"Reservar Sala",-1)),o(ge),o(M,{flat:"",dense:"",round:"",icon:"close",class:"q-ml-auto",onClick:a[1]||(a[1]=e=>j.value=!1)})]),_:1}),o(E,null,{default:c(()=>[o(be,{onSubmit:ie(ae,["prevent"])},{default:c(()=>[o(B,{modelValue:w.value,"onUpdate:modelValue":a[2]||(a[2]=e=>w.value=e),label:"Nombre",dense:"",outlined:"",class:"",rules:[e=>!!e||"Por favor, ingresa un nombre."]},null,8,["modelValue","rules"]),o(B,{modelValue:$.value,"onUpdate:modelValue":a[3]||(a[3]=e=>$.value=e),modelModifiers:{number:!0},type:"number",label:"Número de Personas",dense:"",outlined:"",class:"",rules:[e=>e>0||"Por favor, ingresa un número válido."]},null,8,["modelValue","rules"]),o(B,{modelValue:p.value,"onUpdate:modelValue":a[4]||(a[4]=e=>p.value=e),modelModifiers:{number:!0},type:"number",label:"Adelanto",dense:"",outlined:"",class:"",rules:[e=>e>=0||"Por favor, ingresa un número válido."]},null,8,["modelValue","rules"]),o(B,{modelValue:q.value,"onUpdate:modelValue":a[5]||(a[5]=e=>q.value=e),label:"Observación",dense:"",outlined:"",type:"textarea"},null,8,["modelValue"]),o(ce,{modelValue:y.value,"onUpdate:modelValue":[a[6]||(a[6]=e=>y.value=e),a[7]||(a[7]=e=>p.value=R.value)],label:y.value?"Venta Directa":"Reserva",class:G({"text-primary":y.value,"text-orange":!y.value})},null,8,["modelValue","label","class"]),v("div",null,[o(Z,{color:"indigo",class:"q-pa-sm"},{default:c(()=>[O(" Horario Seleccionado: Desde "+f(Y.value)+" hasta "+f(A.value),1)]),_:1})]),v("div",qe," Tiempo Total: "+f(P.value),1),v("div",Be," Monto Total: "+f(R.value)+" Bs ",1),v("div",Me," Saldo: "+f(R.value-p.value)+" Bs ",1),o(ve,{align:"right"},{default:c(()=>[de(o(M,{flat:"",label:"Cancelar","no-caps":"",loading:g.value},null,8,["loading"]),[[pe]]),o(M,{color:"green",label:"Confirmar","no-caps":"",type:"submit",loading:g.value},null,8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}};export{ze as default};
